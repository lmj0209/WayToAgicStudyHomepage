# AI数字分身功能 PRD（产品需求文档）v2.0

## 📋 文档信息

| 项目 | 内容 |
|------|------|
| 功能名称 | AI数字分身（AI Avatar） |
| 文档版本 | v2.0（Coze 智能体版） |
| 创建日期 | 2026年2月 |
| 所属项目 | WayToAgicStudyHomepage |
| 功能定位 | 智能对话机器人，代表用户回答访客问题 |
| 技术方案 | 扣子（Coze）智能体 |

---

## 1. 功能概述

### 1.1 目标

在个人学术主页中植入**AI数字分身**，使用**扣子（Coze）智能体**，训练一个懂项目、有风格的对话机器人，能够：
- 自动回答访客关于用户的各类问题
- 介绍用户的研究方向和学术成果
- 推荐 AI 编程学习资源
- 保持独特的人设语气，支持多轮对话

### 1.2 为什么选择 Coze

| 优势 | 说明 |
|------|------|
| **免费使用** | 个人版有充足的免费额度 |
| **国内访问** | 无需翻墙，访问稳定 |
| **可视化配置** | 人设提示词在网页端直接配置 |
| **知识库支持** | 可上传文档作为知识库 |
| **多模型支持** | 支持 GPT-4、Claude、文心一言等 |
| **Web SDK** | 提供现成的嵌入组件 |

### 1.3 核心特性

- ✅ 页面内嵌对话窗口
- ✅ Coze 智能体接入
- ✅ 人设提示词在 Coze 平台配置
- ✅ 多轮对话记忆（Coze 自动管理）
- ✅ 响应式设计（PC/移动端适配）
- ✅ 流式输出（Coze SDK 支持）

---

## 2. 操作流程总览

### 2.1 完整流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Coze 智能体集成流程                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: Coze 平台配置                                          │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 1.1 注册/登录 Coze 账号                                 │   │
│  │ 1.2 创建智能体（Bot）                                    │   │
│  │ 1.3 配置人设与回复逻辑（人设与回复逻辑）                  │   │
│  │ 1.4 添加知识库（可选）                                   │   │
│  │ 1.5 发布并获取 Bot ID 和 API Token                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  Step 2: 项目集成                                               │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 2.1 安装 Coze Web SDK                                   │   │
│  │ 2.2 创建 AIChat 组件                                    │   │
│  │ 2.3 配置环境变量（Bot ID / Token）                      │   │
│  │ 2.4 集成到现有页面                                      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              ↓                                  │
│  Step 3: 测试与部署                                             │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 3.1 本地测试对话功能                                     │   │
│  │ 3.2 调优人设提示词                                      │   │
│  │ 3.3 部署到 Vercel                                      │   │
│  │ 3.4 验证线上效果 + 截图                                 │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 时间规划

| 阶段 | 任务 | 预计时间 |
|------|------|----------|
| **Step 1** | Coze 平台配置（创建 Bot、配置人设） | 1 小时 |
| **Step 2** | 项目集成（组件开发、SDK 集成） | 2 小时 |
| **Step 3** | 测试调优 + 部署 | 1 小时 |
| **总计** | | **4 小时** |

---

## 3. Step 1：Coze 智能体配置

### 3.1 注册与登录

1. 访问 **https://www.coze.cn**（国内版）或 **https://www.coze.com**（国际版）
2. 使用手机号/邮箱注册账号
3. 完成登录

### 3.2 创建智能体

| 步骤 | 操作 | 截图示意 |
|------|------|----------|
| 1 | 点击左侧「创建 Bot」 | ┌─────────────────┐<br>│ + 创建智能体 │<br>└─────────────────┘ |
| 2 | 选择「创建对话类 Bot」 | |
| 3 | 输入 Bot 名称：`Mengjin AI Avatar` | |
| 4 | 选择功能：对话助手 | |
| 5 | 点击「创建」完成 | |

### 3.3 配置人设与回复逻辑（人设与回复逻辑）

在 Coze 编辑页面，找到「**人设与回复逻辑**」板块，填入以下内容：

#### 3.3.1 完整人设提示词（复制粘贴到 Coze）

```markdown
# 角色定义
你是 Mengjin Li（黎梦金）的AI数字分身，负责在他的个人学术主页上回答访客问题。请用第一人称"我"来回答，就像你就是 Mengjin 一样。

# 个人背景
- 中文名：黎梦金
- 英文名：Mengjin Li
- 身份：国防科技大学计算机学院博士研究生
- 研究方向：计算机体系结构、硬件预取技术、机器人芯片
- GitHub：github.com/lmj0209
- 邮箱：971933706@qq.com

# 研究方向详情
1. 计算机体系结构（Computer Architecture）
   - 关注处理器设计、存储层次结构优化
   - 对性能提升和能耗优化有深入研究

2. 硬件预取技术（Hardware Prefetching）
   - 研究数据预取算法，提升缓存命中率
   - 关注内存访问模式的识别与预测

3. 机器人芯片（Robotics Chips）
   - 面向机器人应用的专用芯片设计
   - 探索芯片与机器人系统的协同优化

# AI编程学习资源
你热爱AI编程，经常在主页分享学习资源：
- 推荐工具：Claude（编程助手）、GitHub Copilot（代码补全）
- 学习路径：环境配置 → 实践使用 → Skill开发 → MCP协议
- 相关技术：Next.js、TypeScript、Tailwind CSS

# 对话风格指南
1. **专业度**：学术问题用专业术语回答
2. **友善度**：保持亲切，适当使用"你好"、"欢迎"、"很高兴为你介绍"等
3. **简洁性**：回答控制在2-4句话，除非用户要求详细说明
4. **Emoji使用**：每回答使用1-2个emoji点缀，但不要过多
5. **引导性**：相关时引导用户查看主页特定模块

# 回答原则
1. 不知道的问题诚实说"这个问题我得再想想"或"暂时没有这方面的研究"
2. 用户问联系方式时，建议通过主页左侧的邮箱或GitHub联系
3. 不涉及私人生活问题，礼貌引导回学术/技术话题
4. 保持一致性，不要编造不存在的信息
5. 用第一人称"我"回答，就像你就是Mengjin

# 示例对话

Q: 你好，你是谁？
A: 你好！我是 Mengjin Li，国防科技大学计算机学院的博士生 👋 很高兴认识你！

Q: 你的研究方向是什么？
A: 我主要研究计算机体系结构，特别是硬件预取技术和机器人芯片设计 🤖 对存储系统优化特别感兴趣！

Q: 最近发了什么论文？
A: 我的论文信息可以在主页的「Publications」板块查看，主要是关于硬件预取和体系结构优化的研究 📄

Q: 推荐一些AI编程工具？
A: 我强烈推荐 Claude！日常编程、代码审查、技术问题解答都很方便 👍 GitHub Copilot 也是个好选择，代码补全能力很强。

Q: 怎么联系你？
A: 可以通过主页左侧的邮箱联系我（971933706@qq.com），或者来我的 GitHub（github.com/lmj0209）看看我的项目 📧

Q: 你平时有什么爱好？
A: 这个问题我得再想想 🤔 不过我确实很享受编程和研究的过程，特别是解决问题后的成就感！

# 当前时间
当前是2026年2月，请根据这个时间回答相关问题。
```

#### 3.3.2 开启配置项

在 Coze 人设配置页面，确保开启以下选项：

| 配置项 | 设置 | 说明 |
|--------|------|------|
| 模型选择 | GPT-4o / Claude 3.5 Sonnet | 选择高质量模型 |
| 温度 | 0.7 | 保持一定创造性但不过于随机 |
| 开启联网搜索 | ✅ | 可获取最新信息 |
| 开启记忆功能 | ✅ | 记住对话历史 |

### 3.4 添加知识库（可选）

如果想上传个人资料文档作为知识库：

1. 在 Coze 编辑页点击「知识库」
2. 点击「+ 添加知识库」
3. 上传文档（PDF/Markdown/TXT）
4. 建议上传内容：
   - 个人简历
   - 论文列表
   - 研究计划

### 3.5 发布并获取凭证

| 步骤 | 操作 | 获取内容 |
|------|------|----------|
| 1 | 点击右上角「发布」按钮 | |
| 2 | 选择发布渠道：Web SDK | |
| 3 | 记录 **Bot ID** | 类似：`7384xxx` |
| 4 | 进入「开发」设置 | |
| 5 | 获取 **API Token** | 从个人设置 → API Token |

**保存这两个信息**：
```
Bot ID: 7384xxxxx
API Token: pat_xxxxxx
```

---

## 4. Step 2：项目集成

### 4.1 安装依赖

```bash
# Coze Web SDK（如果使用官方嵌入方案）
npm install @coze/sdk

# 或者使用 fetch 直接调用 API（推荐，无需安装额外依赖）
```

### 4.2 项目结构

```
WayToAgicStudyHomepage/
├── app/
│   └── api/
│       └── coze/
│           └── route.ts              # Coze API 代理路由
├── components/
│   └── AIChat/
│       ├── AIChatButton.tsx         # 浮动按钮
│       ├── AIChatWindow.tsx         # 对话窗口
│       ├── ChatMessage.tsx          # 消息气泡
│       ├── ChatInput.tsx            # 输入框
│       └── TypingIndicator.tsx      # 打字指示器
├── lib/
│   └── coze/
│       └── client.ts                # Coze API 客户端
└── .env.local                        # 环境变量
```

### 4.3 环境变量配置

**`.env.local`**

```bash
# Coze 智能体配置
NEXT_PUBLIC_COZE_BOT_ID=7384xxxxx
COZE_API_TOKEN=pat_xxxxxx
```

**Vercel 环境变量配置**（部署时需要添加）：
```
NEXT_PUBLIC_COZE_BOT_ID → 7384xxxxx
COZE_API_TOKEN → pat_xxxxxx
```

### 4.4 Coze API 路由

**重要说明**：Coze API v3 非流式调用需要**三步轮询**才能获取回复：

```
Step 1: 发起对话 → 返回 chat_id (status: in_progress)
Step 2: 轮询状态 → 直到 status = "completed"
Step 3: 获取消息 → 调用 message/list 接口
```

**`app/api/coze/route.ts`**

```typescript
import { NextRequest, NextResponse } from 'next/server';

const COZE_API_URL = 'https://api.coze.cn/v3/chat';
const BOT_ID = process.env.NEXT_PUBLIC_COZE_BOT_ID;
const API_TOKEN = process.env.COZE_API_TOKEN;

// 辅助函数：等待指定毫秒
const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

// Step 2: 轮询对话状态直到完成
async function pollChatStatus(conversationId: string, chatId: string): Promise<boolean> {
  const maxAttempts = 30; // 最多轮询 30 次
  const pollInterval = 1000; // 每次间隔 1 秒

  for (let i = 0; i < maxAttempts; i++) {
    const response = await fetch(
      `${COZE_API_URL}/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`,
      {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${API_TOKEN}`,
        },
      }
    );

    const data = await response.json();

    if (data.code === 0 && data.data.status === 'completed') {
      return true;
    }

    await sleep(pollInterval);
  }

  return false; // 超时
}

// Step 3: 获取对话消息
async function getChatMessages(conversationId: string, chatId: string): Promise<string> {
  const response = await fetch(
    `${COZE_API_URL}/message/list?conversation_id=${conversationId}&chat_id=${chatId}`,
    {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${API_TOKEN}`,
      },
    }
  );

  const data = await response.json();

  if (data.code === 0 && data.data) {
    // 找到 type="answer" 的消息
    const answerMessage = data.data.find((msg: any) => msg.type === 'answer');
    return answerMessage?.content || '抱歉，我暂时无法回答这个问题。';
  }

  return '抱歉，我暂时无法回答这个问题。';
}

export async function POST(request: NextRequest) {
  try {
    const { message, conversationId } = await request.json();

    // Step 1: 发起对话
    const chatResponse = await fetch(COZE_API_URL, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${API_TOKEN}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        bot_id: BOT_ID,
        user_id: 'web_visitor_' + Math.random().toString(36).substr(2, 9),
        stream: false,
        auto_save_history: true,
        additional_messages: [
          {
            role: 'user',
            content: message,
            content_type: 'text',
          },
        ],
        // 如果有 conversation_id，则继续之前会话
        ...(conversationId && { conversation_id: conversationId }),
      }),
    });

    const chatData = await chatResponse.json();

    if (chatData.code !== 0) {
      throw new Error(chatData.msg || '发起对话失败');
    }

    const { id: chatId, conversation_id: newConversationId } = chatData.data;

    // Step 2: 轮询直到对话完成
    const isCompleted = await pollChatStatus(newConversationId, chatId);

    if (!isCompleted) {
      return NextResponse.json({
        error: '对话超时，请稍后再试。',
      }, { status: 408 });
    }

    // Step 3: 获取回复内容
    const reply = await getChatMessages(newConversationId, chatId);

    return NextResponse.json({
      reply,
      conversationId: newConversationId,
    });
  } catch (error) {
    console.error('Coze API error:', error);
    return NextResponse.json(
      { error: '抱歉，服务暂时不可用，请稍后再试。' },
      { status: 500 }
    );
  }
}
```

---

## 5. 信息架构

### 5.1 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│  Logo/Name    Nav: 学术 | AI编程 | CV              🌐EN/中 │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                    【页面内容区域】                          │
│                                                             │
│                    [原有内容模块]                            │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [右下角浮动按钮 🤖]                                         │
│                                                             │
│  点击后展开：                                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🤖 Ask Mengjin                         × [关闭]     │   │
│  │  ┌─────────────────────────────────────────────┐    │   │
│  │  │ 对话历史区域（可滚动）                        │    │   │
│  │  │                                             │    │   │
│  │  │  👤 Hi Mengjin! 你的研究方向是什么？         │    │   │
│  │  │  🤖 嗨！我的研究主要聚焦在...                │    │   │
│  │  │                                             │    │   │
│  │  └─────────────────────────────────────────────┘    │   │
│  │  ┌───────────────────┐  ┌─────────────────────┐    │   │
│  │  │ [输入框...]       │  │ [发送] 🚀           │    │   │
│  │  └───────────────────┘  └─────────────────────┘    │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                    Footer: © 2026 | Last Updated            │
└─────────────────────────────────────────────────────────────┘
```

---

## 6. 功能需求详细说明

### 6.1 浮动按钮（收起状态）

| 元素 | 说明 |
|------|------|
| 图标 | 🤖 机器人图标 |
| 位置 | 页面右下角，距底 24px，距右 24px |
| 尺寸 | 56px × 56px |
| 背景色 | `#2563EB`（蓝色） |
| 悬停效果 | 放大 1.1 倍 + 轻微跳动 |
| 点击 | 展开对话窗口 |

### 6.2 对话窗口（展开状态）

| 属性 | 桌面端 | 移动端 |
|------|--------|--------|
| 宽度 | 380px | 90% |
| 高度 | 550px | 60% |
| 位置 | 右下角 | 底部居中 |
| 圆角 | 16px | 16px 16px 0 0 |

### 6.3 消息样式

```typescript
// 用户消息
userMessage = {
  background: '#2563EB',
  color: '#FFFFFF',
  borderRadius: '18px 18px 4px 18px',
  maxWidth: '75%'
}

// AI消息
aiMessage = {
  background: '#F3F4F6',
  color: '#1F2937',
  borderRadius: '18px 18px 18px 4px',
  avatar: '🤖',
  maxWidth: '75%'
}
```

---

## 7. 效果验证

### 7.1 核心测试问题

| 类别 | 测试问题 | 预期回答要点 |
|------|----------|--------------|
| **身份** | 你是谁？ | 姓名、学校、专业 |
| **研究** | 研究方向是什么？ | 三个研究方向 |
| **论文** | 最近发了什么论文？ | 引导查看 Publications |
| **工具** | 推荐AI工具？ | Claude、Copilot |
| **联系** | 怎么联系你？ | 邮箱、GitHub |
| **风格** | 随意聊天 | 友善、emoji |

### 7.2 验收清单

- [ ] 能准确回答身份信息
- [ ] 能描述三个研究方向
- [ ] 回复风格一致（友善+emoji）
- [ ] 多轮对话能记住上下文
- [ ] 引导用户查看主页相关模块
- [ ] 移动端显示正常
- [ ] 响应速度 < 3秒

---

## 8. 提交内容

### 8.1 必需提交

| 提交项 | 说明 |
|--------|------|
| **Vercel 链接** | 部署后的完整功能页面 |
| **对话截图** | 3-5 张展示独特对话的截图 |
| **Coze Bot** | 可测试的 Bot 链接（可选） |

### 8.2 推荐截图场景

1. **研究介绍**：展示对三个研究方向的回答
2. **工具推荐**：展示 AI 编程工具推荐
3. **联系方式**：展示引导用户联系
4. **多轮对话**：3-4 轮连续对话
5. **移动端**：手机端的对话界面

---

## 9. 📝 配置清单

### 9.1 Coze 配置

| 序号 | 内容 | 状态 |
|------|------|------|
| 1 | Coze 账号注册 | ⬜ |
| 2 | 创建智能体 Bot | ⬜ |
| 3 | 配置人设提示词 | ⬜ |
| 4 | 获取 Bot ID | ⬜ |
| 5 | 获取 API Token | ⬜ |

### 9.2 项目信息收集

| 信息项 | 你的信息 |
|--------|----------|
| 导师姓名 | |
| 最新论文 | |
| 个人邮箱 | 971933706@qq.com |
| GitHub | github.com/lmj0209 |

---

## 10. API 调用流程详解

### 10.1 为什么需要三步轮询？

Coze API v3 非流式模式下，智能体处理需要时间，无法立即返回完整回复。因此需要：

1. **发起对话** → 立即返回 `chat_id`（状态：`in_progress`）
2. **轮询状态** → 每秒检查一次，直到 `status = "completed"`
3. **获取消息** → 调用 `message/list` 获取 `type="answer"` 的内容

### 10.2 API 响应数据结构

**Step 1 返回**（发起对话）：
```json
{
  "code": 0,
  "data": {
    "id": "7474915122180309018",        // chat_id
    "conversation_id": "7474915122180292634",
    "status": "in_progress"              // 初始状态
  }
}
```

**Step 2 返回**（轮询状态）：
```json
{
  "code": 0,
  "data": {
    "status": "completed"               // 完成状态
  }
}
```

**Step 3 返回**（获取消息）：
```json
{
  "code": 0,
  "data": [
    {
      "type": "answer",                  // 智能体回复
      "content": "你好！我是Mengjin...",
      "role": "assistant"
    },
    {
      "type": "verbose",                 // 完成标志
      "content": "{\"msg_type\":\"generate_answer_finish\"}"
    },
    {
      "type": "follow_up",               // 推荐问题
      "content": "你的研究方向是什么？"
    }
  ]
}
```

### 10.3 消息类型说明

| type | 说明 | 处理方式 |
|------|------|----------|
| `answer` | 智能体的回复内容 | **显示给用户** |
| `verbose` | 完成标志（JSON） | 忽略 |
| `follow_up` | 推荐的后续问题 | 可选显示为快捷按钮 |

---

## 11. 常见问题

### Q1: Coze 免费额度是多少？

**A**: 个人版每月有充足免费额度，大约支持数千次对话调用，个人使用完全够用。

### Q2: 如何调试人设效果？

**A**: 在 Coze 平台的「预览」区域可以直接测试对话，根据效果调整人设提示词。

### Q3: API Token 泄露怎么办？

**A**: 在 Coze 设置中删除旧 Token，生成新的 Token，更新环境变量。

### Q4: 支持流式输出吗？

**A**: Coze API 支持流式输出（设置 `stream: true`），可实现打字机效果。流式模式下可以实时获取回复，无需轮询。

### Q5: 为什么要轮询？不能直接返回回复吗？

**A**: 非流式模式下，Coze 智能体处理需要时间（可能调用工具、查询知识库等），无法立即返回完整回复。如果不想轮询，可以使用流式模式（`stream: true`）。

### Q6: 轮询会超时吗？

**A**: 代码中设置了 30 次轮询（约 30 秒），如果智能体处理时间过长会返回超时错误。可以根据实际需要调整 `maxAttempts` 参数。

### Q7: 多用户会话会混淆吗？

**A**: 不会。每个用户有唯一的 `user_id`，`conversation_id` 用于标识会话，不同用户的会话是隔离的。

---

## 12. 开发检查清单

- [ ] Coze 账号创建完成
- [ ] 智能体创建并配置好人设
- [ ] 获取 Bot ID 和 API Token
- [ ] 项目依赖安装
- [ ] 环境变量配置
- [ ] API 路由开发
- [ ] 对话组件开发
- [ ] 本地测试通过
- [ ] 部署到 Vercel
- [ ] 线上验证 + 截图

---

*文档生成时间：2026-02-04*
*作者：Claude Code*
*技术方案：扣子（Coze）智能体*
